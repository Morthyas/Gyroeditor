<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>GyroEditor 5.0</title>
  <style>
    body { background:#111; color:#fff; text-align:center; font-family:Arial; margin:0; }
    body.light { background:#f0f0f0; color:#111; }
    header { display:flex; justify-content:space-between; padding:10px; background:#222; }
    header button { margin:0 5px; padding:8px 12px; border:none; border-radius:5px; background:#444; color:#fff; }
    header button:hover { background:#666; cursor:pointer; }
    #canvas { max-width:100%; margin-top:10px; }
    #controls { margin-top:10px; }
    #controls button { margin:5px; padding:8px 12px; border:none; border-radius:5px; background:#444; color:#fff; }
    #controls button:hover { background:#666; cursor:pointer; }
    #tipOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:#fff; display:none; align-items:center; justify-content:center; text-align:center; padding:20px; }
    #tipOverlay button { margin-top:20px; background:#28a745; }
    #cropArea { position:absolute; border:2px dashed #fff; display:none; }
  </style>
</head>
<body>
<header>
  <div>
    <button id="uploadBtn">Upload</button>
    <button id="modeBtn">Gyro</button>
    <button id="themeBtn">Dark/Light</button>
  </div>
  <div>
    <button id="undoBtn">Undo</button>
    <button id="redoBtn">Redo</button>
    <button id="resetBtn">Reset</button>
    <button id="saveBtn">Save</button>
  </div>
</header>

<canvas id="canvas"></canvas>
<div id="controls">
  <button class="mode" data-mode="brightness">Jas</button>
  <button class="mode" data-mode="contrast">Kontrast</button>
  <button class="mode" data-mode="saturate">Saturace</button>
  <button class="mode" data-mode="hue">Odstín</button>
  <button class="mode" data-mode="metallic">Metalický</button>
  <button class="mode" data-mode="aging">Aging</button>
  <button id="cropBtn">Crop</button>
</div>

<div id="tipOverlay">
  <div>
    <h2>Vítejte v GyroEditoru!</h2>
    <p>Nakláněním telefonu nebo tažením prstem měníte hodnoty.<br>Klikněte na režimy (Jas, Kontrast, …) pro úpravy.<br>Přepínejte mezi Gyro/Touch, ořezávejte, ukládejte.</p>
    <button id="closeTips">Rozumím</button>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" style="display:none;">
<div id="cropArea"></div>

<script>
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const fileInput = document.getElementById("fileInput");
  const tipOverlay = document.getElementById("tipOverlay");
  const cropArea = document.getElementById("cropArea");
  let img = new Image();
  let currentMode = "brightness";
  let controlMode = "gyro";
  let history = [], redoStack = [];
  let cropping = false;
  let cropStartX, cropStartY;
  let fixOffset = 0;
  let currentFilters = { brightness:100, contrast:100, saturate:100, hue:0, metallic:0, aging:0 };

  function pushHistory() {
    history.push(canvas.toDataURL());
    redoStack = [];
  }

  function applyFilters() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.filter = `
      brightness(${currentFilters.brightness}%)
      contrast(${currentFilters.contrast}%)
      saturate(${currentFilters.saturate}%)
      hue-rotate(${currentFilters.hue}deg)
      sepia(${currentFilters.aging/100})
    `;
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
  }

  function loadImage(src) {
    img = new Image();
    img.onload = () => {
      const aspect = img.width / img.height;
      if (aspect > 1) { canvas.width = window.innerWidth; canvas.height = window.innerWidth / aspect; }
      else { canvas.height = window.innerHeight * 0.7; canvas.width = canvas.height * aspect; }
      applyFilters();
      pushHistory();
    };
    img.src = src;
  }

  document.getElementById("uploadBtn").onclick = ()=>fileInput.click();
  fileInput.onchange = e => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = ev => loadImage(ev.target.result);
      reader.readAsDataURL(file);
    }
  };

  document.querySelectorAll(".mode").forEach(btn=>{
    btn.onclick=()=>{
      currentMode = btn.dataset.mode;
      flattenImage();
    };
  });

  function flattenImage() {
    const data = canvas.toDataURL();
    loadImage(data);
  }

  document.getElementById("modeBtn").onclick=()=>{
    controlMode = controlMode==="gyro" ? "touch":"gyro";
    document.getElementById("modeBtn").textContent = controlMode==="gyro"?"Gyro":"Touch";
  };

  document.getElementById("themeBtn").onclick=()=>{
    document.body.classList.toggle("light");
  };

  document.getElementById("undoBtn").onclick=()=>{
    if (history.length>1) {
      redoStack.push(history.pop());
      loadImage(history[history.length-1]);
    }
  };
  document.getElementById("redoBtn").onclick=()=>{
    if (redoStack.length>0) {
      const data = redoStack.pop();
      loadImage(data);
    }
  };
  document.getElementById("resetBtn").onclick=()=>{
    if (history.length>0) loadImage(history[0]);
  };
  document.getElementById("saveBtn").onclick=()=>{
    const link = document.createElement('a');
    link.download='upraveny_obrazek.png';
    link.href=canvas.toDataURL();
    link.click();
  };

  // Gyro
  window.addEventListener('deviceorientation', e=>{
    if (controlMode!=="gyro") return;
    if (e.gamma!==null) {
      let val = Math.min(200, Math.max(0, 100 + (e.gamma - fixOffset) * (200/30)));
      adjustFilter(val);
    }
  });

  // Touch
  let touching=false, lastX=0;
  canvas.addEventListener('touchstart',e=>{if(controlMode==="touch"){touching=true;lastX=e.touches[0].clientX;}});
  canvas.addEventListener('touchmove',e=>{
    if(controlMode==="touch" && touching){
      let dx=e.touches[0].clientX - lastX;
      lastX = e.touches[0].clientX;
      adjustFilter(currentFilters[currentMode]+dx);
    }
  });
  canvas.addEventListener('touchend',()=>{touching=false;});

  function adjustFilter(val){
    if (currentMode==="hue") currentFilters.hue = val;
    else if (currentMode==="metallic") currentFilters.metallic = val;
    else if (currentMode==="aging") currentFilters.aging = val;
    else currentFilters[currentMode] = val;
    applyFilters();
  }

  // Crop
  document.getElementById("cropBtn").onclick=()=>{
    cropping = !cropping;
    cropArea.style.display = cropping ? "block" : "none";
  };
  canvas.addEventListener('mousedown',e=>{
    if (!cropping) return;
    cropStartX = e.offsetX; cropStartY = e.offsetY;
    cropArea.style.left = e.pageX+"px";
    cropArea.style.top = e.pageY+"px";
    cropArea.style.width="0px"; cropArea.style.height="0px";
    cropArea.style.display="block";
    function onMove(ev){
      cropArea.style.width = Math.abs(ev.pageX - e.pageX)+"px";
      cropArea.style.height = Math.abs(ev.pageY - e.pageY)+"px";
      cropArea.style.left = Math.min(ev.pageX,e.pageX)+"px";
      cropArea.style.top = Math.min(ev.pageY,e.pageY)+"px";
    }
    function onUp(ev){
      const endX = ev.offsetX, endY = ev.offsetY;
      const sx = Math.min(cropStartX,endX), sy = Math.min(cropStartY,endY);
      const sw = Math.abs(cropStartX-endX), sh = Math.abs(cropStartY-endY);
      const cropped = ctx.getImageData(sx,sy,sw,sh);
      canvas.width = sw; canvas.height = sh;
      ctx.putImageData(cropped,0,0);
      cropArea.style.display="none";
      cropping=false;
      pushHistory();
      document.removeEventListener('mousemove',onMove);
      document.removeEventListener('mouseup',onUp);
    }
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onUp);
  });

  document.getElementById("closeTips").onclick=()=>tipOverlay.style.display="none";
  window.onload=()=>tipOverlay.style.display="flex";

  // Drag & Drop
  document.body.ondragover=e=>{e.preventDefault();};
  document.body.ondrop=e=>{
    e.preventDefault();
    const file=e.dataTransfer.files[0];
    if(file){
      const reader=new FileReader();
      reader.onload=ev=>loadImage(ev.target.result);
      reader.readAsDataURL(file);
    }
  };

  loadImage("https://picsum.photos/800/500");
</script>
</body>
</html>
